# é‡åŒ–äº¤æ˜“ç³»ç»Ÿæµ‹è¯•å¥—ä»¶

## ğŸ“‹ æµ‹è¯•ç»“æ„

æœ¬æµ‹è¯•å¥—ä»¶é‡‡ç”¨åˆ†å±‚æµ‹è¯•æ¶æ„ï¼Œå…¨é¢è¦†ç›–ç³»ç»Ÿçš„å„ä¸ªå±‚æ¬¡ï¼š

### ğŸ—ï¸ æµ‹è¯•å±‚æ¬¡

1. **TushareæœåŠ¡å±‚æµ‹è¯•** (`test_tushare_service.py`)
   - Tushare APIé›†æˆæµ‹è¯•
   - æ•°æ®è·å–å’Œè½¬æ¢æµ‹è¯•
   - é”™è¯¯å¤„ç†å’Œé™æµæµ‹è¯•
   - å­—æ®µå¸¸é‡ä½¿ç”¨æµ‹è¯•

2. **DAOå±‚æµ‹è¯•** (`test_dao_layer.py`)
   - æ•°æ®è®¿é—®å¯¹è±¡æµ‹è¯•
   - æ‰¹é‡æ“ä½œæµ‹è¯•
   - æŸ¥è¯¢å’Œè¿‡æ»¤æµ‹è¯•
   - æ•°æ®éªŒè¯æµ‹è¯•

3. **ä¸šåŠ¡æœåŠ¡å±‚æµ‹è¯•** (`test_business_services.py`)
   - ä¸šåŠ¡é€»è¾‘æµ‹è¯•
   - æœåŠ¡é›†æˆæµ‹è¯•
   - ç¼“å­˜æœºåˆ¶æµ‹è¯•
   - é”™è¯¯å¤„ç†æµ‹è¯•

4. **APIå±‚æµ‹è¯•** (`test_api_layer.py`)
   - REST APIç«¯ç‚¹æµ‹è¯•
   - è¯·æ±‚éªŒè¯æµ‹è¯•
   - å“åº”æ ¼å¼æµ‹è¯•
   - é”™è¯¯å¤„ç†æµ‹è¯•

5. **é›†æˆæµ‹è¯•** (`test_integration.py`)
   - ç«¯åˆ°ç«¯æµç¨‹æµ‹è¯•
   - è·¨å±‚é›†æˆæµ‹è¯•
   - æ€§èƒ½æµ‹è¯•
   - å¹¶å‘æµ‹è¯•

6. **å·¥å…·ç±»æµ‹è¯•** (`test_utils.py`)
   - å·¥å…·å‡½æ•°æµ‹è¯•
   - æ—¥æœŸå¤„ç†æµ‹è¯•
   - æ•°å­—æ ¼å¼åŒ–æµ‹è¯•
   - å¹¶å‘å·¥å…·æµ‹è¯•

## ğŸš€ å¿«é€Ÿå¼€å§‹

### å®‰è£…ä¾èµ–

```bash
pip install pytest pytest-cov pytest-xdist
```

### è¿è¡Œæ‰€æœ‰æµ‹è¯•

```bash
# åŸºæœ¬è¿è¡Œ
python tests/run_tests.py

# è¯¦ç»†è¾“å‡º
python tests/run_tests.py --verbose

# ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
python tests/run_tests.py --coverage

# å¹¶è¡Œæ‰§è¡Œ
python tests/run_tests.py --parallel
```

### è¿è¡Œç‰¹å®šå±‚æµ‹è¯•

```bash
# TushareæœåŠ¡å±‚
python tests/run_tests.py --layer tushare

# DAOå±‚
python tests/run_tests.py --layer dao

# ä¸šåŠ¡æœåŠ¡å±‚
python tests/run_tests.py --layer service

# APIå±‚
python tests/run_tests.py --layer api

# é›†æˆæµ‹è¯•
python tests/run_tests.py --layer integration

# å·¥å…·ç±»
python tests/run_tests.py --layer utils
```

### è¿è¡Œç‰¹å®šæµ‹è¯•

```bash
# è¿è¡ŒåŒ…å«ç‰¹å®šå…³é”®è¯çš„æµ‹è¯•
python tests/run_tests.py --pattern "test_stock"

# è¿è¡Œç‰¹å®šæµ‹è¯•æ–‡ä»¶
python tests/run_tests.py --pattern "test_tushare_service.py"
```

## ğŸ“Š æµ‹è¯•è¦†ç›–ç‡

### ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š

```bash
# ç”ŸæˆHTMLå’Œç»ˆç«¯è¦†ç›–ç‡æŠ¥å‘Š
python tests/run_tests.py --coverage

# åªç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
python tests/run_tests.py --coverage-only
```

### æŸ¥çœ‹è¦†ç›–ç‡æŠ¥å‘Š

- ç»ˆç«¯æŠ¥å‘Šï¼šç›´æ¥åœ¨å‘½ä»¤è¡ŒæŸ¥çœ‹
- HTMLæŠ¥å‘Šï¼šæ‰“å¼€ `htmlcov/index.html`

## ğŸ§ª æµ‹è¯•æ•°æ®

### æµ‹è¯•æ•°æ®åº“

- ä½¿ç”¨SQLiteå†…å­˜æ•°æ®åº“è¿›è¡Œæµ‹è¯•
- æ¯ä¸ªæµ‹è¯•ç”¨ä¾‹ç‹¬ç«‹çš„æ•°æ®ç¯å¢ƒ
- è‡ªåŠ¨æ¸…ç†æµ‹è¯•æ•°æ®

### Mockæ•°æ®

- ä½¿ç”¨unittest.mockæ¨¡æ‹Ÿå¤–éƒ¨ä¾èµ–
- æ¨¡æ‹ŸTushare APIå“åº”
- æ¨¡æ‹ŸRedisç¼“å­˜æ“ä½œ
- æ¨¡æ‹Ÿæ•°æ®åº“æ“ä½œ

## ğŸ“ æµ‹è¯•ç”¨ä¾‹è¯´æ˜

### TushareæœåŠ¡å±‚æµ‹è¯•

```python
class TestTushareService:
    def test_get_stock_basic(self):
        """æµ‹è¯•è·å–è‚¡ç¥¨åŸºç¡€ä¿¡æ¯"""
        
    def test_get_concept_basic(self):
        """æµ‹è¯•è·å–æ¦‚å¿µåŸºç¡€ä¿¡æ¯"""
        
    def test_api_error_handling(self):
        """æµ‹è¯•APIé”™è¯¯å¤„ç†"""
```

### DAOå±‚æµ‹è¯•

```python
class TestStockDAO:
    def test_bulk_upsert_stock_data_success(self):
        """æµ‹è¯•æ‰¹é‡æ’å…¥è‚¡ç¥¨æ•°æ®æˆåŠŸ"""
        
    def test_get_stock_by_ts_code_found(self):
        """æµ‹è¯•æ ¹æ®è‚¡ç¥¨ä»£ç è·å–è‚¡ç¥¨ä¿¡æ¯"""
```

### ä¸šåŠ¡æœåŠ¡å±‚æµ‹è¯•

```python
class TestStockService:
    def test_sync_stock_basic_info_success(self):
        """æµ‹è¯•åŒæ­¥è‚¡ç¥¨åŸºç¡€ä¿¡æ¯æˆåŠŸ"""
        
    def test_get_all_ts_codes_cached(self):
        """æµ‹è¯•è·å–æ‰€æœ‰è‚¡ç¥¨ä»£ç ï¼ˆç¼“å­˜ï¼‰"""
```

### APIå±‚æµ‹è¯•

```python
class TestStockAPI:
    def test_get_stocks_success(self):
        """æµ‹è¯•è·å–è‚¡ç¥¨åˆ—è¡¨æˆåŠŸ"""
        
    def test_get_stock_klines_success(self):
        """æµ‹è¯•è·å–è‚¡ç¥¨Kçº¿æ•°æ®æˆåŠŸ"""
```

## ğŸ”§ æµ‹è¯•é…ç½®

### conftest.py

æä¾›å…¬å…±çš„æµ‹è¯•é…ç½®å’Œfixturesï¼š

- `db_session`: æµ‹è¯•æ•°æ®åº“ä¼šè¯
- `client`: FastAPIæµ‹è¯•å®¢æˆ·ç«¯
- `sample_*_data`: ç¤ºä¾‹æµ‹è¯•æ•°æ®
- `mock_*_service`: æ¨¡æ‹ŸæœåŠ¡

### æµ‹è¯•ç¯å¢ƒå˜é‡

æµ‹è¯•ä½¿ç”¨ç‹¬ç«‹çš„é…ç½®ï¼Œä¸ä¼šå½±å“ç”Ÿäº§ç¯å¢ƒï¼š

- æµ‹è¯•æ•°æ®åº“ï¼šSQLiteå†…å­˜æ•°æ®åº“
- Mockå¤–éƒ¨æœåŠ¡ï¼šTushareã€Redisç­‰
- ç‹¬ç«‹æ—¥å¿—ï¼šæµ‹è¯•ä¸“ç”¨æ—¥å¿—é…ç½®

## ğŸ“ˆ æ€§èƒ½æµ‹è¯•

### å¤§æ•°æ®é›†æµ‹è¯•

```python
def test_large_dataset_query_performance(self):
    """æµ‹è¯•å¤§æ•°æ®é›†æŸ¥è¯¢æ€§èƒ½"""
    # æ’å…¥1000æ¡æµ‹è¯•æ•°æ®
    # éªŒè¯æŸ¥è¯¢æ—¶é—´ < 1ç§’
```

### å¹¶å‘æµ‹è¯•

```python
def test_concurrent_requests_integration(self):
    """æµ‹è¯•å¹¶å‘è¯·æ±‚é›†æˆ"""
    # 10ä¸ªå¹¶å‘è¯·æ±‚
    # éªŒè¯æ‰€æœ‰è¯·æ±‚æˆåŠŸ
```

## ğŸ› é”™è¯¯å¤„ç†æµ‹è¯•

### æ•°æ®åº“é”™è¯¯

```python
def test_database_error_integration(self):
    """æµ‹è¯•æ•°æ®åº“é”™è¯¯å¤„ç†é›†æˆ"""
    # æ¨¡æ‹Ÿæ•°æ®åº“è¿æ¥å¤±è´¥
    # éªŒè¯é”™è¯¯å“åº”
```

### APIé”™è¯¯

```python
def test_tushare_api_error_integration(self):
    """æµ‹è¯•Tushare APIé”™è¯¯å¤„ç†é›†æˆ"""
    # æ¨¡æ‹ŸAPIè°ƒç”¨å¤±è´¥
    # éªŒè¯é”™è¯¯å¤„ç†
```

## ğŸ“‹ æµ‹è¯•æœ€ä½³å®è·µ

### 1. æµ‹è¯•å‘½å

- ä½¿ç”¨æè¿°æ€§çš„æµ‹è¯•æ–¹æ³•å
- æ ¼å¼ï¼š`test_åŠŸèƒ½_æ¡ä»¶_æœŸæœ›ç»“æœ`
- ä¾‹å¦‚ï¼š`test_get_stock_basic_success`

### 2. æµ‹è¯•ç»“æ„

- Arrangeï¼šå‡†å¤‡æµ‹è¯•æ•°æ®
- Actï¼šæ‰§è¡Œè¢«æµ‹è¯•çš„åŠŸèƒ½
- Assertï¼šéªŒè¯ç»“æœ

### 3. æµ‹è¯•éš”ç¦»

- æ¯ä¸ªæµ‹è¯•ç”¨ä¾‹ç‹¬ç«‹è¿è¡Œ
- ä¸ä¾èµ–å…¶ä»–æµ‹è¯•ç”¨ä¾‹çš„ç»“æœ
- ä½¿ç”¨fixturesæä¾›æµ‹è¯•æ•°æ®

### 4. Mockä½¿ç”¨

- æ¨¡æ‹Ÿå¤–éƒ¨ä¾èµ–
- æ§åˆ¶æµ‹è¯•ç¯å¢ƒ
- æé«˜æµ‹è¯•ç¨³å®šæ€§

## ğŸš¨ æ³¨æ„äº‹é¡¹

### 1. æµ‹è¯•æ•°æ®

- ä½¿ç”¨æµ‹è¯•ä¸“ç”¨çš„ç¤ºä¾‹æ•°æ®
- é¿å…ä½¿ç”¨ç”Ÿäº§æ•°æ®
- ç¡®ä¿æ•°æ®çš„ä¸€è‡´æ€§å’Œå¯é‡å¤æ€§

### 2. ç¯å¢ƒéš”ç¦»

- æµ‹è¯•ç¯å¢ƒä¸ç”Ÿäº§ç¯å¢ƒå®Œå…¨éš”ç¦»
- ä½¿ç”¨ç‹¬ç«‹çš„æ•°æ®åº“å’Œé…ç½®
- ä¸ä¾èµ–å¤–éƒ¨æœåŠ¡

### 3. æµ‹è¯•ç»´æŠ¤

- åŠæ—¶æ›´æ–°æµ‹è¯•ç”¨ä¾‹
- ä¿æŒæµ‹è¯•ç”¨ä¾‹çš„ç®€æ´æ€§
- å®šæœŸæ£€æŸ¥æµ‹è¯•è¦†ç›–ç‡

## ğŸ“ æ”¯æŒ

å¦‚æœ‰æµ‹è¯•ç›¸å…³é—®é¢˜ï¼Œè¯·ï¼š

1. æŸ¥çœ‹æµ‹è¯•æ—¥å¿—è¾“å‡º
2. æ£€æŸ¥æµ‹è¯•è¦†ç›–ç‡æŠ¥å‘Š
3. å‚è€ƒç°æœ‰æµ‹è¯•ç”¨ä¾‹
4. è”ç³»å¼€å‘å›¢é˜Ÿ

---

**Happy Testing! ğŸ‰**
